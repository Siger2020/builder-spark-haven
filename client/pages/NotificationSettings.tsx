import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Separator } from "@/components/ui/separator";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { toast } from "sonner";
import {
  Mail,
  Settings,
  Send,
  CheckCircle,
  XCircle,
  Clock,
  AlertTriangle,
  BarChart3,
  History,
  TestTube,
  Shield,
  ExternalLink,
  Wifi,
  WifiOff,
  Activity,
  Info,
  HelpCircle,
  Copy,
  RefreshCw,
} from "lucide-react";
import { emailJSService } from "../services/emailJSService";
import { 
  EmailJSSettings, 
  defaultEmailJSSettings, 
  SETUP_GUIDE, 
  EMAIL_TEMPLATES,
  ConnectionStatus,
  getConnectionStatusText,
  getConnectionStatusColor
} from "../lib/emailConfig";

interface NotificationLog {
  id: number;
  notification_type: string;
  recipient_email: string;
  recipient_name: string;
  appointment_id?: string;
  subject: string;
  sent_at?: string;
  delivery_status: string;
  error_message?: string;
  created_at: string;
}

interface NotificationStats {
  total: number;
  successful: number;
  failed: number;
  pending: number;
  byType: Array<{
    notification_type: string;
    total: number;
    successful: number;
    failed: number;
    pending: number;
  }>;
}

export default function NotificationSettings() {
  const [activeTab, setActiveTab] = useState("settings");
  const [emailJSSettings, setEmailJSSettings] = useState<EmailJSSettings>(defaultEmailJSSettings);
  const [testEmail, setTestEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isTesting, setIsTesting] = useState(false);
  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>(ConnectionStatus.NOT_CONFIGURED);
  const [notificationLogs, setNotificationLogs] = useState<NotificationLog[]>([]);
  const [notificationStats, setNotificationStats] = useState<NotificationStats | null>(null);
  const [showGuide, setShowGuide] = useState(false);

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS
  const loadEmailJSSettings = async () => {
    try {
      // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖŸÜ localStorage
      const savedSettings = localStorage.getItem('emailjs_settings');
      if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        setEmailJSSettings(settings);
        
        // ÿ™ŸÉŸàŸäŸÜ ÿßŸÑÿÆÿØŸÖÿ©
        emailJSService.configure(settings);
        setConnectionStatus(emailJSService.getConnectionStatus());
      }
    } catch (error) {
      console.error('Error loading EmailJS settings:', error);
      toast.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS');
    }
  };

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ (ŸÖÿ≠ŸÅŸàÿ∏ ŸÑŸÑÿ™ŸàÿßŸÅŸÇ)
  const loadNotificationLogs = async () => {
    try {
      const response = await fetch('/api/notifications/logs?limit=50');
      const data = await response.json();
      
      if (data.success) {
        setNotificationLogs(data.data);
      }
    } catch (error) {
      console.error('Error loading notification logs:', error);
      // ŸÑÿß ŸÜÿ∏Ÿáÿ± ÿÆÿ∑ÿ£ ŸáŸÜÿß ŸÑÿ£ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÇÿØ ŸÑÿß ÿ™ŸÉŸàŸÜ ŸÖÿ™ŸàŸÅÿ±ÿ©
    }
  };

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ (ŸÖÿ≠ŸÅŸàÿ∏ ŸÑŸÑÿ™ŸàÿßŸÅŸÇ)
  const loadNotificationStats = async () => {
    try {
      const response = await fetch('/api/notifications/stats');
      const data = await response.json();
      
      if (data.success) {
        setNotificationStats(data.data);
      }
    } catch (error) {
      console.error('Error loading notification stats:', error);
      // ŸÑÿß ŸÜÿ∏Ÿáÿ± ÿÆÿ∑ÿ£ ŸáŸÜÿß ŸÑÿ£ŸÜ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÇÿØ ŸÑÿß ÿ™ŸÉŸàŸÜ ŸÖÿ™ŸàŸÅÿ±ÿ©
    }
  };

  // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS
  const saveEmailJSSettings = async () => {
    setIsLoading(true);
    
    try {
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
      const configResult = emailJSService.configure(emailJSSettings);
      
      if (!configResult.success) {
        toast.error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™: ${configResult.errors?.join(', ')}`);
        return;
      }

      // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸä localStorage
      localStorage.setItem('emailjs_settings', JSON.stringify(emailJSSettings));
      
      setConnectionStatus(emailJSService.getConnectionStatus());
      toast.success('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS ÿ®ŸÜÿ¨ÿßÿ≠');
      
      // ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖŸÅÿπŸÑ
      if (emailJSSettings.enabled) {
        await testEmailJSConnection();
      }
    } catch (error) {
      console.error('Error saving EmailJS settings:', error);
      toast.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS');
    } finally {
      setIsLoading(false);
    }
  };

  // ÿßÿÆÿ™ÿ®ÿßÿ± ÿßÿ™ÿµÿßŸÑ EmailJS
  const testEmailJSConnection = async () => {
    setIsTesting(true);
    setConnectionStatus(ConnectionStatus.TESTING);
    
    try {
      const result = await emailJSService.testConnection();
      
      if (result.success) {
        setConnectionStatus(ConnectionStatus.CONNECTED);
        toast.success('‚úÖ ÿ™ŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
      } else {
        setConnectionStatus(ConnectionStatus.ERROR);
        toast.error(`‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ: ${result.error}`);
      }
    } catch (error) {
      setConnectionStatus(ConnectionStatus.ERROR);
      console.error('Error testing EmailJS connection:', error);
      toast.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿÆÿ™ÿ®ÿßÿ± ÿßÿ™ÿµÿßŸÑ EmailJS');
    } finally {
      setIsTesting(false);
    }
  };

  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ±ŸäÿØ ÿßÿÆÿ™ÿ®ÿßÿ± ÿπÿ®ÿ± EmailJS
  const sendTestEmail = async () => {
    if (!testEmail) {
      toast.error('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±');
      return;
    }

    if (!emailJSService.isConfigured()) {
      toast.error('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÉŸàŸäŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS ÿ£ŸàŸÑÿßŸã');
      return;
    }

    setIsTesting(true);

    try {
      const result = await emailJSService.sendTestEmail(testEmail);

      if (result.success) {
        toast.success('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ±ŸäÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
        setTestEmail('');
      } else {
        toast.error(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ±ŸäÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±: ${result.error}`);
      }
    } catch (error) {
      console.error('Error sending test email:', error);
      toast.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ±ŸäÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±');
    } finally {
      setIsTesting(false);
    }
  };

  // ÿßÿÆÿ™ÿ®ÿßÿ± ÿ•ÿ¥ÿπÿßÿ± ÿ≠ÿ¨ÿ≤ ÿ≠ŸÇŸäŸÇŸä ÿπÿ®ÿ± EmailJS
  const sendTestBookingNotification = async () => {
    if (!testEmail) {
      toast.error('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±');
      return;
    }

    if (!emailJSService.isConfigured()) {
      toast.error('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÉŸàŸäŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS ÿ£ŸàŸÑÿßŸã');
      return;
    }

    setIsTesting(true);

    try {
      const result = await emailJSService.sendTestBookingNotification(testEmail);

      if (result.success) {
        toast.success(`‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ¨ÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿπÿØ: ${result.appointmentId}`);
        setTestEmail('');
      } else {
        toast.error(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ≠ÿ¨ÿ≤: ${result.error}`);
      }
    } catch (error) {
      console.error('Error sending test booking notification:', error);
      toast.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ≠ÿ¨ÿ≤ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä');
    } finally {
      setIsTesting(false);
    }
  };

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿµŸÅÿ≠ÿ©
  useEffect(() => {
    loadEmailJSSettings();
    loadNotificationLogs();
    loadNotificationStats();
  }, []);

  // ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ŸÑŸàŸÜ badge ÿ≠ÿ≥ÿ® ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'sent':
      case 'delivered':
        return <Badge variant="default" className="bg-green-500"><CheckCircle className="w-3 h-3 ml-1" />ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ</Badge>;
      case 'failed':
        return <Badge variant="destructive"><XCircle className="w-3 h-3 ml-1" />ŸÅÿ¥ŸÑ</Badge>;
      case 'pending':
        return <Badge variant="secondary"><Clock className="w-3 h-3 ml-1" />ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</Badge>;
      default:
        return <Badge variant="outline">{status}</Badge>;
    }
  };

  // ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ÿ£ŸäŸÇŸàŸÜÿ© ŸÜŸàÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
  const getNotificationTypeIcon = (type: string) => {
    switch (type) {
      case 'confirmation':
        return '‚úÖ';
      case 'reminder':
        return '‚è∞';
      case 'cancellation':
        return '‚ùå';
      case 'test':
        return 'üß™';
      default:
        return 'üìß';
    }
  };

  // ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿµ ŸÑŸÑÿ≠ÿßŸÅÿ∏ÿ©
  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ŸÑŸÑÿ≠ÿßŸÅÿ∏ÿ©');
  };

  // ŸÖÿ§ÿ¥ÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
  const ConnectionStatusIndicator = () => {
    const statusText = getConnectionStatusText(connectionStatus);
    const statusColor = getConnectionStatusColor(connectionStatus);
    
    const getStatusIcon = () => {
      switch (connectionStatus) {
        case ConnectionStatus.NOT_CONFIGURED:
          return <WifiOff className="w-4 h-4" />;
        case ConnectionStatus.CONFIGURED:
          return <Activity className="w-4 h-4" />;
        case ConnectionStatus.TESTING:
          return <RefreshCw className="w-4 h-4 animate-spin" />;
        case ConnectionStatus.CONNECTED:
          return <Wifi className="w-4 h-4" />;
        case ConnectionStatus.ERROR:
          return <XCircle className="w-4 h-4" />;
        default:
          return <WifiOff className="w-4 h-4" />;
      }
    };

    return (
      <div className="flex items-center gap-2">
        <div className={`flex items-center gap-1 ${statusColor}`}>
          {getStatusIcon()}
          <span className="text-sm font-medium">{statusText}</span>
        </div>
      </div>
    );
  };

  return (
    <div className="container mx-auto p-6 max-w-6xl" dir="rtl">
      <div className="flex items-center gap-4 mb-8">
        <Mail className="h-8 w-8 text-dental-primary" />
        <div>
          <h1 className="text-3xl font-bold text-gray-900 font-arabic">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©</h1>
          <p className="text-gray-600 font-arabic">ŸÜÿ∏ÿßŸÖ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ™ÿ∑Ÿàÿ± ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ EmailJS</p>
        </div>
        <div className="mr-auto">
          <ConnectionStatusIndicator />
        </div>
      </div>

      <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="settings" className="font-arabic">
            <Settings className="w-4 h-4 ml-2" />
            ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS
          </TabsTrigger>
          <TabsTrigger value="test" className="font-arabic">
            <TestTube className="w-4 h-4 ml-2" />
            ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±
          </TabsTrigger>
          <TabsTrigger value="guide" className="font-arabic">
            <HelpCircle className="w-4 h-4 ml-2" />
            ÿØŸÑŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØ
          </TabsTrigger>
          <TabsTrigger value="stats" className="font-arabic">
            <BarChart3 className="w-4 h-4 ml-2" />
            ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
          </TabsTrigger>
        </TabsList>

        <TabsContent value="settings" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="font-arabic flex items-center gap-2">
                <Shield className="w-5 h-5" />
                ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©
              </CardTitle>
              <CardDescription className="font-arabic">
                ŸÉŸàŸëŸÜ EmailJS ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ© ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ®ÿØŸàŸÜ ÿÆÿßÿØŸÖ ÿÆŸÑŸÅŸä
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="flex items-center space-x-2 space-x-reverse">
                <Switch
                  id="emailjs-enabled"
                  checked={emailJSSettings.enabled}
                  onCheckedChange={(checked) =>
                    setEmailJSSettings(prev => ({ ...prev, enabled: checked }))
                  }
                />
                <Label htmlFor="emailjs-enabled" className="font-arabic">
                  ÿ™ŸÅÿπŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ© (EmailJS)
                </Label>
              </div>

              {emailJSSettings.enabled && (
                <div className="space-y-4 p-4 border rounded-lg bg-gray-50">
                  <Alert>
                    <Info className="h-4 w-4" />
                    <AlertDescription className="font-arabic">
                      üìß <strong>ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©:</strong> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ≠ŸÇŸäŸÇŸäÿ© ŸÑŸÑŸÖÿ±ÿ∂Ÿâ ÿπÿ®ÿ± ÿÆÿØŸÖÿ© EmailJS.
                      ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÉŸÖÿßŸÑ ÿ•ÿπÿØÿßÿØ EmailJS ÿ£ŸàŸÑÿßŸã (ÿ±ÿßÿ¨ÿπ ÿ™ÿ®ŸàŸäÿ® "ÿØŸÑŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØ").
                    </AlertDescription>
                  </Alert>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label htmlFor="service-id" className="font-arabic">Service ID</Label>
                      <Input
                        id="service-id"
                        value={emailJSSettings.serviceId}
                        onChange={(e) =>
                          setEmailJSSettings(prev => ({ ...prev, serviceId: e.target.value }))
                        }
                        placeholder="service_xxxxxxx"
                        dir="ltr"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="template-id" className="font-arabic">Template ID</Label>
                      <Input
                        id="template-id"
                        value={emailJSSettings.templateId}
                        onChange={(e) =>
                          setEmailJSSettings(prev => ({ ...prev, templateId: e.target.value }))
                        }
                        placeholder="template_xxxxxxx"
                        dir="ltr"
                      />
                    </div>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="public-key" className="font-arabic">Public Key</Label>
                    <Input
                      id="public-key"
                      value={emailJSSettings.publicKey}
                      onChange={(e) =>
                        setEmailJSSettings(prev => ({ ...prev, publicKey: e.target.value }))
                      }
                      placeholder="your_public_key_here"
                      dir="ltr"
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label htmlFor="sender-name" className="font-arabic">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ÿ≥ŸÑ</Label>
                      <Input
                        id="sender-name"
                        value={emailJSSettings.senderName}
                        onChange={(e) =>
                          setEmailJSSettings(prev => ({ ...prev, senderName: e.target.value }))
                        }
                        placeholder="ÿπŸäÿßÿØÿ© ÿßŸÑÿØŸÉÿ™Ÿàÿ± ŸÉŸÖÿßŸÑ ÿßŸÑŸÖŸÑÿµŸä"
                        className="font-arabic"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="sender-email" className="font-arabic">ÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ±ÿ≥ŸÑ</Label>
                      <Input
                        id="sender-email"
                        type="email"
                        value={emailJSSettings.senderEmail}
                        onChange={(e) =>
                          setEmailJSSettings(prev => ({ ...prev, senderEmail: e.target.value }))
                        }
                        placeholder="info@clinic.com"
                        dir="ltr"
                      />
                    </div>
                  </div>

                  <Alert>
                    <Shield className="h-4 w-4" />
                    <AlertDescription className="font-arabic">
                      <strong>ÿ£ŸÖÿßŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:</strong> ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ™Ÿèÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã ŸÅŸä ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸàŸÑÿß ÿ™Ÿèÿ±ÿ≥ŸÑ ŸÑÿ£Ÿä ÿÆÿßÿØŸÖ ÿÆÿßÿ±ÿ¨Ÿä.
                      EmailJS ÿ¢ŸÖŸÜ ŸàŸÑÿß ŸäŸÉÿ¥ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿßÿ≥ÿ©.
                    </AlertDescription>
                  </Alert>
                </div>
              )}

              <Separator />

              <div className="flex gap-4">
                <Button onClick={saveEmailJSSettings} disabled={isLoading} className="font-arabic">
                  {isLoading ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏..." : "ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™"}
                </Button>
                
                {emailJSSettings.enabled && (
                  <Button variant="outline" onClick={testEmailJSConnection} disabled={isTesting} className="font-arabic">
                    {isTesting ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±..." : "ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ"}
                  </Button>
                )}

                <Button 
                  variant="ghost" 
                  onClick={() => setActiveTab("guide")} 
                  className="font-arabic"
                >
                  <HelpCircle className="w-4 h-4 ml-2" />
                  ÿØŸÑŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØ
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="test" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="font-arabic">ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÇŸäŸÇŸä</CardTitle>
              <CardDescription className="font-arabic">
                ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ≠ŸÇŸäŸÇŸäÿ© ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="space-y-2">
                <Label htmlFor="test-email" className="font-arabic">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±</Label>
                <Input
                  id="test-email"
                  type="email"
                  value={testEmail}
                  onChange={(e) => setTestEmail(e.target.value)}
                  placeholder="test@example.com"
                  dir="ltr"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Card className="border-dashed">
                  <CardContent className="p-4">
                    <h4 className="font-bold mb-2 font-arabic">üß™ ÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿ≥Ÿäÿ∑</h4>
                    <p className="text-sm text-gray-600 mb-3 font-arabic">
                      Ÿäÿ±ÿ≥ŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS
                    </p>
                    <Button
                      onClick={sendTestEmail}
                      disabled={isTesting || !testEmail || !emailJSSettings.enabled}
                      className="w-full font-arabic"
                      variant="outline"
                    >
                      <TestTube className="w-4 h-4 ml-2" />
                      {isTesting ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ..." : "ÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿ≥Ÿäÿ∑"}
                    </Button>
                  </CardContent>
                </Card>

                <Card className="border-dashed border-dental-primary">
                  <CardContent className="p-4">
                    <h4 className="font-bold mb-2 font-arabic text-dental-primary">üìß ŸÖÿ≠ÿßŸÉÿßÿ© ÿ≠ÿ¨ÿ≤ ÿ≠ŸÇŸäŸÇŸä</h4>
                    <p className="text-sm text-gray-600 mb-3 font-arabic">
                      Ÿäÿ±ÿ≥ŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ¨ÿ≤ ŸÉÿßŸÖŸÑ ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ (ÿßŸÑÿ£ŸÅÿ∂ŸÑ ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±)
                    </p>
                    <Button
                      onClick={sendTestBookingNotification}
                      disabled={isTesting || !testEmail || !emailJSSettings.enabled}
                      className="w-full font-arabic"
                    >
                      <Send className="w-4 h-4 ml-2" />
                      {isTesting ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ..." : "ÿßÿÆÿ™ÿ®ÿßÿ± ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ¨ÿ≤"}
                    </Button>
                  </CardContent>
                </Card>
              </div>

              {!emailJSSettings.enabled && (
                <Alert>
                  <AlertTriangle className="h-4 w-4" />
                  <AlertDescription className="font-arabic">
                    Ÿäÿ¨ÿ® ÿ™ŸÅÿπŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ Ÿàÿ•ÿπÿØÿßÿØ EmailJS ÿ£ŸàŸÑÿßŸã ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                  </AlertDescription>
                </Alert>
              )}

              {emailJSSettings.enabled && connectionStatus === ConnectionStatus.CONNECTED && (
                <Alert>
                  <CheckCircle className="h-4 w-4" />
                  <AlertDescription className="font-arabic">
                    ‚úÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖÿ™ÿµŸÑ ŸàŸÖÿ≥ÿ™ÿπÿØ ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ! ÿ¨ÿ±ÿ® "ÿßÿÆÿ™ÿ®ÿßÿ± ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ¨ÿ≤" ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ÿ™ÿ¨ÿ±ÿ®ÿ©.
                  </AlertDescription>
                </Alert>
              )}

              {emailJSSettings.enabled && connectionStatus === ConnectionStatus.ERROR && (
                <Alert variant="destructive">
                  <XCircle className="h-4 w-4" />
                  <AlertDescription className="font-arabic">
                    ‚ùå ŸáŸÜÿßŸÉ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ EmailJS ÿ£Ÿà ÿ±ÿßÿ¨ÿπ ÿØŸÑŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØ.
                  </AlertDescription>
                </Alert>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="guide" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="font-arabic">ÿØŸÑŸäŸÑ ÿ•ÿπÿØÿßÿØ EmailJS</CardTitle>
              <CardDescription className="font-arabic">
                ÿßÿ™ÿ®ÿπ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ŸÑÿ•ÿπÿØÿßÿØ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Accordion type="single" collapsible className="w-full">
                {SETUP_GUIDE.steps.map((step, index) => (
                  <AccordionItem key={index} value={`step-${index}`}>
                    <AccordionTrigger className="font-arabic text-right">
                      {step.title}
                    </AccordionTrigger>
                    <AccordionContent className="space-y-4">
                      <p className="font-arabic">{step.description}</p>
                      <ul className="list-disc list-inside space-y-2 font-arabic">
                        {step.details.map((detail, detailIndex) => (
                          <li key={detailIndex} className="text-sm text-gray-600">{detail}</li>
                        ))}
                      </ul>
                      {index === 0 && (
                        <Button 
                          variant="outline" 
                          onClick={() => window.open('https://www.emailjs.com', '_blank')}
                          className="font-arabic"
                        >
                          <ExternalLink className="w-4 h-4 ml-2" />
                          ÿ≤Ÿäÿßÿ±ÿ© ŸÖŸàŸÇÿπ EmailJS
                        </Button>
                      )}
                    </AccordionContent>
                  </AccordionItem>
                ))}
              </Accordion>

              <Separator className="my-6" />

              <div className="space-y-4">
                <h3 className="text-lg font-bold font-arabic">ŸÇŸàÿßŸÑÿ® ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©</h3>
                <p className="text-sm text-gray-600 font-arabic">
                  ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÇÿßŸÑÿ® Ÿàÿßÿ≠ÿØ ŸÑÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ° ŸÇŸàÿßŸÑÿ® ŸÖŸÜŸÅÿµŸÑÿ©
                </p>
                
                {Object.entries(EMAIL_TEMPLATES).map(([key, template]) => (
                  <Card key={key} className="border-l-4 border-l-blue-500">
                    <CardContent className="p-4">
                      <h4 className="font-bold font-arabic mb-2">{template.name}</h4>
                      <p className="text-sm text-gray-600 font-arabic mb-3">{template.description}</p>
                      <div className="space-y-2">
                        <Label className="font-arabic text-sm">ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÔøΩÔøΩ:</Label>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                          {template.variables.map((variable) => (
                            <div key={variable} className="flex items-center gap-1">
                              <code className="text-xs bg-gray-100 px-1 rounded">{`{{${variable}}}`}</code>
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => copyToClipboard(`{{${variable}}}`)}
                                className="h-6 w-6 p-0"
                              >
                                <Copy className="w-3 h-3" />
                              </Button>
                            </div>
                          ))}
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>

              <Separator className="my-6" />

              <div className="space-y-4">
                <h3 className="text-lg font-bold font-arabic">ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° Ÿàÿ•ÿµŸÑÿßÿ≠Ÿáÿß</h3>
                
                {SETUP_GUIDE.troubleshooting.map((item, index) => (
                  <Card key={index}>
                    <CardContent className="p-4">
                      <h4 className="font-bold font-arabic mb-2 text-red-600">{item.issue}</h4>
                      <ul className="list-disc list-inside space-y-1 font-arabic">
                        {item.solutions.map((solution, solutionIndex) => (
                          <li key={solutionIndex} className="text-sm text-gray-600">{solution}</li>
                        ))}
                      </ul>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="stats" className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 font-arabic">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</p>
                    <p className="text-2xl font-bold text-dental-primary">{notificationStats?.total || 0}</p>
                  </div>
                  <Mail className="h-8 w-8 text-dental-primary" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 font-arabic">ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠</p>
                    <p className="text-2xl font-bold text-green-600">{notificationStats?.successful || 0}</p>
                  </div>
                  <CheckCircle className="h-8 w-8 text-green-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 font-arabic">ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ</p>
                    <p className="text-2xl font-bold text-red-600">{notificationStats?.failed || 0}</p>
                  </div>
                  <XCircle className="h-8 w-8 text-red-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 font-arabic">ŸÜÿ∏ÿßŸÖ EmailJS</p>
                    <p className="text-sm font-bold text-blue-600">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©</p>
                  </div>
                  <Shield className="h-8 w-8 text-blue-600" />
                </div>
              </CardContent>
            </Card>
          </div>

          <Alert>
            <Info className="h-4 w-4" />
            <AlertDescription className="font-arabic">
              <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ© ŸáŸÜÿß ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸÅŸÇÿ∑. 
              ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿπÿ®ÿ± EmailJS ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑŸáÿß ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ≠ŸÑŸä.
            </AlertDescription>
          </Alert>
        </TabsContent>
      </Tabs>
    </div>
  );
}
